<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <!-- Meta tag for CORS security -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content:">
    <title>LegalSwami - AI Legal Assistant</title>
    
    <!-- Font Awesome with CORS fix -->
    <link rel="stylesheet" 
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          crossorigin="anonymous" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          referrerpolicy="no-referrer">
    
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer crossorigin="anonymous"></script>
    
    <!-- jsPDF Library for PDF generation with CORS fix -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            crossorigin="anonymous" 
            integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" 
            referrerpolicy="no-referrer"></script>
    
    <!-- html2pdf for fallback PDF generation with CORS fix -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" 
            crossorigin="anonymous" 
            integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" 
            referrerpolicy="no-referrer"></script>
    
    <!-- html2canvas with CORS fix -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" 
            crossorigin="anonymous" 
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" 
            referrerpolicy="no-referrer"></script>
    
    <style>
        /* Previous CSS remains exactly the same */
        :root {
            --primary: #10a37f;
            --primary-dark: #0d8c6d;
            --primary-light: #12b886;
            --secondary: #7e57c2;
            --accent: #ec4899;
            --dark-bg: #0a0a0a;
            --dark-surface: #171717;
            --dark-surface-light: #262626;
            --dark-border: #404040;
            --dark-text: #f8fafc;
            --dark-text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            /* Light mode variables */
            --light-bg: #f8fafc;
            --light-surface: #ffffff;
            --light-surface-light: #f1f5f9;
            --light-border: #e2e8f0;
            --light-text: #0f172a;
            --light-text-secondary: #475569;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--dark-bg);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        body.light-mode {
            background: var(--light-bg);
            color: var(--light-text);
        }
        
        /* NEW LOGIN MODAL STYLES */
        .login-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .login-modal-overlay.active {
            display: flex;
        }
        
        .login-modal {
            background: var(--dark-surface);
            border-radius: 20px;
            border: 1px solid var(--dark-border);
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideIn 0.4s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .light-mode .login-modal {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        .login-header {
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid var(--dark-border);
            background: linear-gradient(135deg, rgba(16, 163, 127, 0.1) 0%, rgba(126, 87, 194, 0.1) 100%);
        }
        
        .light-mode .login-header {
            border-bottom-color: var(--light-border);
        }
        
        .login-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-header p {
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
        }
        
        .light-mode .login-header p {
            color: var(--light-text-secondary);
        }
        
        .login-content {
            padding: 2rem;
        }
        
        .login-features {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .login-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.8rem;
            background: var(--dark-surface-light);
            border-radius: 12px;
            border: 1px solid var(--dark-border);
        }
        
        .light-mode .login-feature {
            background: var(--light-surface-light);
            border-color: var(--light-border);
        }
        
        .login-feature i {
            color: var(--primary);
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .login-feature h4 {
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .login-feature p {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .login-feature p {
            color: var(--light-text-secondary);
        }
        
        .google-login-btn {
            width: 100%;
            padding: 1rem;
            background: white;
            color: #444;
            border: 1px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 1.5rem;
        }
        
        .google-login-btn:hover {
            background: #f8f8f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .google-login-btn i {
            color: #4285F4;
            font-size: 1.2rem;
        }
        
        .google-login-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .login-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--dark-border);
            text-align: center;
            font-size: 0.85rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .login-footer {
            border-top-color: var(--light-border);
        }
        
        .login-footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .login-footer a:hover {
            text-decoration: underline;
        }
        
        /* User Profile Styles */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .user-profile:hover {
            background: var(--dark-surface-light);
            border-color: var(--dark-border);
        }
        
        .light-mode .user-profile:hover {
            background: var(--light-surface-light);
            border-color: var(--light-border);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-email {
            font-size: 0.75rem;
            color: var(--dark-text-secondary);
            white-space: nowrap;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .light-mode .user-email {
            color: var(--light-text-secondary);
        }
        
        /* User Profile Dropdown */
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 15px;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            min-width: 250px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
        }
        
        .light-mode .user-dropdown {
            background: var(--light-surface);
            border-color: var(--light-border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .user-dropdown.active {
            display: block;
        }
        
        .dropdown-header {
            padding: 1.2rem;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .light-mode .dropdown-header {
            border-bottom-color: var(--light-border);
        }
        
        .dropdown-header .user-avatar {
            width: 44px;
            height: 44px;
        }
        
        .dropdown-header .user-info {
            flex: 1;
        }
        
        .dropdown-header .user-name {
            font-size: 1rem;
        }
        
        .dropdown-items {
            padding: 0.5rem;
        }
        
        .dropdown-item {
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--dark-text);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .light-mode .dropdown-item {
            color: var(--light-text);
        }
        
        .dropdown-item:hover {
            background: var(--dark-surface-light);
        }
        
        .light-mode .dropdown-item:hover {
            background: var(--light-surface-light);
        }
        
        .dropdown-item i {
            width: 20px;
            text-align: center;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .dropdown-item i {
            color: var(--light-text-secondary);
        }
        
        .dropdown-item.logout {
            color: var(--error);
        }
        
        .dropdown-item.logout:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .dropdown-footer {
            padding: 0.8rem;
            border-top: 1px solid var(--dark-border);
            font-size: 0.75rem;
            color: var(--dark-text-secondary);
            text-align: center;
        }
        
        .light-mode .dropdown-footer {
            border-top-color: var(--light-border);
            color: var(--light-text-secondary);
        }
        
        /* Rest of the CSS remains exactly the same as before */
        /* ... All the previous CSS code ... */
        
        /* Container */
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background: var(--dark-bg);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .light-mode .container {
            background: var(--light-bg);
        }
        
        /* Header - FIXED FOR MOBILE */
        header {
            background: var(--dark-surface);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--dark-border);
            position: sticky;
            top: 0;
            z-index: 100;
            min-height: 64px;
            transition: all 0.3s ease;
            width: 100%;
            flex-shrink: 0;
        }
        
        .light-mode header {
            background: var(--light-surface);
            border-bottom-color: var(--light-border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .logo-icon {
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .logo h1 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .header-btn {
            background: var(--dark-surface-light);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            min-height: 40px;
            flex-shrink: 0;
        }
        
        .light-mode .header-btn {
            background: var(--light-surface-light);
            color: var(--light-text);
            border-color: var(--light-border);
        }
        
        .header-btn:hover {
            background: var(--dark-border);
            transform: translateY(-1px);
        }
        
        .light-mode .header-btn:hover {
            background: var(--light-border);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0.4rem 0.8rem;
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid rgba(16, 163, 127, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .light-mode .status-indicator {
            background: rgba(16, 163, 127, 0.08);
            border-color: rgba(16, 163, 127, 0.2);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--dark-surface-light);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .light-mode .theme-toggle {
            background: var(--light-surface-light);
            border-color: var(--light-border);
        }
        
        .theme-toggle:hover {
            transform: rotate(15deg);
        }
        
        .theme-toggle i {
            color: var(--dark-text);
            transition: all 0.3s;
        }
        
        .light-mode .theme-toggle i {
            color: var(--light-text);
        }
        
        /* Voice Search Button in Header */
        .voice-search-btn {
            background: var(--dark-surface-light);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            flex-shrink: 0;
        }
        
        .light-mode .voice-search-btn {
            background: var(--light-surface-light);
            border-color: var(--light-border);
        }
        
        .voice-search-btn:hover {
            transform: translateY(-1px);
        }
        
        .voice-search-btn.listening {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            animation: pulse 1.5s infinite;
        }
        
        .voice-search-btn i {
            color: var(--dark-text);
        }
        
        .light-mode .voice-search-btn i {
            color: var(--light-text);
        }
        
        /* Sidebar Toggle Button */
        .sidebar-toggle {
            background: transparent;
            border: none;
            color: var(--dark-text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }
        
        .light-mode .sidebar-toggle {
            color: var(--light-text);
        }
        
        .sidebar-toggle:hover {
            background: var(--dark-surface-light);
        }
        
        .light-mode .sidebar-toggle:hover {
            background: var(--light-surface-light);
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            width: 100%;
            min-height: 0;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--dark-surface);
            border-right: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 50;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            overflow: hidden;
            transform: translateX(-100%);
        }
        
        .light-mode .sidebar {
            background: var(--light-surface);
            border-right-color: var(--light-border);
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        /* Sidebar Close Button */
        .sidebar-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--dark-surface-light);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .light-mode .sidebar-close {
            background: var(--light-surface-light);
            color: var(--light-text);
            border-color: var(--light-border);
        }
        
        .sidebar-close:hover {
            background: var(--dark-border);
            transform: rotate(90deg);
        }
        
        .light-mode .sidebar-close:hover {
            background: var(--light-border);
        }
        
        /* Sidebar Tabs */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--dark-border);
            background: var(--dark-surface);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .light-mode .sidebar-tabs {
            background: var(--light-surface);
            border-bottom-color: var(--light-border);
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .light-mode .sidebar-tab {
            color: var(--light-text-secondary);
        }
        
        .sidebar-tab:hover {
            color: var(--dark-text);
            background: var(--dark-surface-light);
        }
        
        .light-mode .sidebar-tab:hover {
            color: var(--light-text);
            background: var(--light-surface-light);
        }
        
        .sidebar-tab.active {
            color: var(--primary);
        }
        
        .sidebar-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 3px 3px 0 0;
        }
        
        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding-top: 0.5rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Legal Topics Tab Content */
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--dark-border);
            position: sticky;
            top: 0;
            background: var(--dark-surface);
            z-index: 10;
        }
        
        .light-mode .sidebar-header {
            background: var(--light-surface);
            border-bottom-color: var(--light-border);
        }
        
        .sidebar-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .light-mode .sidebar-header h2 {
            color: var(--light-text-secondary);
        }
        
        .sidebar-section {
            padding: 1rem;
        }
        
        .sidebar-section h3 {
            font-size: 0.85rem;
            margin-bottom: 0.8rem;
            color: var(--dark-text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .light-mode .sidebar-section h3 {
            color: var(--light-text-secondary);
        }
        
        .topic-list, .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .topic-item, .action-item {
            padding: 0.8rem;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-text-secondary);
            min-height: 44px;
        }
        
        .light-mode .topic-item,
        .light-mode .action-item {
            color: var(--light-text-secondary);
        }
        
        .topic-item:hover, .action-item:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
            transform: translateX(5px);
        }
        
        .light-mode .topic-item:hover,
        .light-mode .action-item:hover {
            background: var(--light-surface-light);
            color: var(--light-text);
        }
        
        .topic-item i, .action-item i {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        /* Chat History Tab Content */
        .history-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--dark-border);
            position: sticky;
            top: 0;
            background: var(--dark-surface);
            z-index: 10;
        }
        
        .light-mode .history-header {
            background: var(--light-surface);
            border-bottom-color: var(--light-border);
        }
        
        .history-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .light-mode .history-header h2 {
            color: var(--light-text-secondary);
        }
        
        .new-chat-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        .history-list {
            padding: 0.5rem;
        }
        
        .history-item {
            padding: 0.8rem;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: var(--dark-text-secondary);
            margin-bottom: 6px;
            position: relative;
        }
        
        .light-mode .history-item {
            color: var(--light-text-secondary);
        }
        
        .history-item:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
        }
        
        .light-mode .history-item:hover {
            background: var(--light-surface-light);
            color: var(--light-text);
        }
        
        .history-item.active {
            background: rgba(16, 163, 127, 0.1);
            border-color: rgba(16, 163, 127, 0.3);
            color: var(--primary);
        }
        
        .light-mode .history-item.active {
            background: rgba(16, 163, 127, 0.08);
            border-color: rgba(16, 163, 127, 0.2);
        }
        
        .history-title {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 60px;
        }
        
        .history-preview {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 60px;
        }
        
        .light-mode .history-preview {
            color: var(--light-text-secondary);
        }
        
        .history-date {
            font-size: 0.7rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .history-date {
            color: var(--light-text-secondary);
        }
        
        /* History Item Actions */
        .history-item-actions {
            display: none;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            gap: 5px;
            background: var(--dark-surface);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid var(--dark-border);
            z-index: 5;
        }
        
        .light-mode .history-item-actions {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        .history-item:hover .history-item-actions {
            display: flex;
        }
        
        .history-item-btn {
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }
        
        .light-mode .history-item-btn {
            color: var(--light-text-secondary);
        }
        
        .history-item-btn:hover {
            background: var(--dark-surface-light);
        }
        
        .light-mode .history-item-btn:hover {
            background: var(--light-surface-light);
        }
        
        .history-item-btn.delete:hover {
            color: var(--error);
        }
        
        .history-item-btn.download:hover {
            color: var(--primary);
        }
        
        .empty-history {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .empty-history {
            color: var(--light-text-secondary);
        }
        
        .empty-history i {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-history p {
            font-size: 0.9rem;
        }
        
        /* Chat Container - FIXED FOR RESPONSIVE */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
            width: 100%;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }
        
        .light-mode .chat-container {
            background: var(--light-bg);
        }
        
        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            width: 100%;
        }
        
        .message {
            display: flex;
            gap: 0.8rem;
            max-width: 100%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
            margin-top: 4px;
        }
        
        .user-message .avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .ai-message .avatar {
            background: linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%);
        }
        
        .message-content {
            max-width: 85%;
            position: relative;
            width: 100%;
        }
        
        .user-message .message-content {
            text-align: right;
        }
        
        .message-text {
            padding: 1rem 1.2rem;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }
        
        .ai-message .message-text {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-top-left-radius: 4px;
            color: var(--dark-text);
        }
        
        .light-mode .ai-message .message-text {
            background: var(--light-surface);
            border-color: var(--light-border);
            color: var(--light-text);
        }
        
        .user-message .message-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        /* Attached Images in Messages - UPDATED: Display below message */
        .message-attachments {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .attachment-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            max-width: 200px;
            border: 1px solid var(--dark-border);
        }
        
        .light-mode .attachment-item {
            border-color: var(--light-border);
        }
        
        .attachment-image {
            max-width: 100%;
            max-height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .attachment-name {
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Message Actions */
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 0.8rem;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: var(--dark-surface-light);
            color: var(--dark-text-secondary);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 32px;
        }
        
        .light-mode .action-btn {
            background: var(--light-surface-light);
            color: var(--light-text-secondary);
            border-color: var(--light-border);
        }
        
        .action-btn:hover {
            background: var(--dark-border);
            color: var(--dark-text);
        }
        
        .light-mode .action-btn:hover {
            background: var(--light-border);
            color: var(--light-text);
        }
        
        .action-btn.copy:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .action-btn.like:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .action-btn.dislike:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }
        
        .action-btn.document:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Download document button inside message */
        .document-download-btn {
            position: absolute;
            top: -15px;
            right: 10px;
            background: var(--dark-surface);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 6px 12px;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            z-index: 5;
            opacity: 0;
            transform: translateY(5px);
        }
        
        .light-mode .document-download-btn {
            background: var(--light-surface);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .ai-message .message-content:hover .document-download-btn {
            opacity: 1;
            transform: translateY(0);
        }
        
        .document-download-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        /* Document Template Styles */
        .document-template {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .light-mode .document-template {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        .document-header {
            text-align: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .document-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        
        .document-subtitle {
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
        }
        
        .light-mode .document-subtitle {
            color: var(--light-text-secondary);
        }
        
        .document-section {
            margin-bottom: 1.5rem;
        }
        
        .document-section-title {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--dark-border);
            word-wrap: break-word;
        }
        
        .light-mode .document-section-title {
            border-bottom-color: var(--light-border);
        }
        
        .document-clause {
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid var(--primary-light);
        }
        
        .clause-title {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        
        .light-mode .clause-title {
            color: var(--light-text);
        }
        
        .clause-content {
            color: var(--dark-text-secondary);
            line-height: 1.6;
            word-wrap: break-word;
        }
        
        .light-mode .clause-content {
            color: var(--light-text-secondary);
        }
        
        .signature-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--dark-border);
        }
        
        .light-mode .signature-section {
            border-top-color: var(--light-border);
        }
        
        .signature-line {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        .signature-block {
            flex: 1;
            padding: 1rem;
            min-width: 150px;
        }
        
        .signature-name {
            border-bottom: 1px solid var(--dark-border);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            min-height: 30px;
        }
        
        .light-mode .signature-name {
            border-bottom-color: var(--light-border);
        }
        
        .signature-label {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .signature-label {
            color: var(--light-text-secondary);
        }
        
        /* Welcome Message */
        .welcome-message {
            text-align: center;
            max-width: 600px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(16, 163, 127, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            width: 90%;
        }
        
        .light-mode .welcome-message {
            background: linear-gradient(135deg, rgba(16, 163, 127, 0.08) 0%, rgba(30, 64, 175, 0.08) 100%);
            border-color: var(--light-border);
        }
        
        .welcome-message h2 {
            font-size: 1.8rem;
            margin-bottom: 0.8rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            word-wrap: break-word;
        }
        
        .welcome-message p {
            color: var(--dark-text-secondary);
            font-size: 1rem;
            margin-bottom: 1.2rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .light-mode .welcome-message p {
            color: var(--light-text-secondary);
        }
        
        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .feature {
            background: var(--dark-surface);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            word-wrap: break-word;
        }
        
        .light-mode .feature {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        .feature i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .feature h4 {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            color: var(--dark-text);
        }
        
        .light-mode .feature h4 {
            color: var(--light-text);
        }
        
        .feature p {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .feature p {
            color: var(--light-text-secondary);
        }
        
        /* Input Area - FIXED POSITIONING */
        .input-container {
            padding: 1rem;
            background: var(--dark-bg);
            border-top: 1px solid var(--dark-border);
            position: sticky;
            bottom: 0;
            z-index: 10;
            transition: all 0.3s ease;
            width: 100%;
            flex-shrink: 0;
        }
        
        .light-mode .input-container {
            background: var(--light-bg);
            border-top-color: var(--light-border);
        }
        
        .input-area {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            width: 100%;
        }
        
        /* Attachments Preview */
        .attachments-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px;
            background: var(--dark-surface-light);
            border-radius: 8px;
            border: 1px solid var(--dark-border);
            max-height: 120px;
            overflow-y: auto;
        }
        
        .light-mode .attachments-preview {
            background: var(--light-surface-light);
            border-color: var(--light-border);
        }
        
        .attachment-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--dark-border);
        }
        
        .light-mode .attachment-preview-item {
            border-color: var(--light-border);
        }
        
        .attachment-preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-attachment {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .attachment-preview-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 4px;
            font-size: 0.6rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .input-area textarea {
            width: 100%;
            padding: 1rem 7.5rem 1rem 1.2rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            color: var(--dark-text);
            font-size: 1rem;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            transition: all 0.3s;
            line-height: 1.5;
            font-family: inherit;
        }
        
        .light-mode .input-area textarea {
            background: var(--light-surface);
            border-color: var(--light-border);
            color: var(--light-text);
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }
        
        /* Input buttons container */
        .input-buttons {
            position: absolute;
            right: 0.8rem;
            bottom: 0.8rem;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* Attachment button */
        .attachment-btn {
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .light-mode .attachment-btn {
            color: var(--light-text-secondary);
        }
        
        .attachment-btn:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
        }
        
        .light-mode .attachment-btn:hover {
            background: var(--light-surface-light);
            color: var(--light-text);
        }
        
        /* Microphone button next to send button */
        .input-microphone-btn {
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .light-mode .input-microphone-btn {
            color: var(--light-text-secondary);
        }
        
        .input-microphone-btn:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
        }
        
        .light-mode .input-microphone-btn:hover {
            background: var(--light-surface-light);
            color: var(--light-text);
        }
        
        .input-microphone-btn.listening {
            color: var(--error);
            animation: pulse 1.5s infinite;
        }
        
        .input-microphone-btn.listening:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .send-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 44px;
            font-size: 0.9rem;
        }
        
        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        .send-button:disabled {
            background: var(--dark-border);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .light-mode .send-button:disabled {
            background: var(--light-border);
        }
        
        /* Voice input status */
        .voice-input-status {
            position: absolute;
            left: 15px;
            bottom: 10px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            gap: 5px;
            animation: fadeIn 0.3s ease;
        }
        
        .voice-input-status.active {
            display: flex;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 1rem 1.2rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            max-width: fit-content;
            margin-left: 3rem;
            margin-top: 0.5rem;
        }
        
        .light-mode .typing-indicator {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark-surface);
            color: var(--dark-text);
            padding: 1rem 1.2rem;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }
        
        .light-mode .toast {
            background: var(--light-surface);
            color: var(--light-text);
            border-color: var(--light-border);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--error);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast.info {
            border-left: 4px solid var(--primary);
        }
        
        /* Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 45;
        }
        
        .light-mode .sidebar-overlay {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Document download modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .light-mode .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--dark-surface);
            border-radius: 16px;
            border: 1px solid var(--dark-border);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .light-mode .modal {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .light-mode .modal-header {
            border-bottom-color: var(--light-border);
        }
        
        .modal-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .light-mode .modal-header h2 {
            color: var(--light-text);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .light-mode .modal-close {
            color: var(--light-text-secondary);
        }
        
        .modal-close:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
        }
        
        .light-mode .modal-close:hover {
            background: var(--light-surface-light);
            color: var(--light-text);
        }
        
        .modal-content {
            padding: 1.5rem;
        }
        
        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .download-option {
            background: var(--dark-surface-light);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .light-mode .download-option {
            background: var(--light-surface-light);
            border-color: var(--light-border);
        }
        
        .download-option:hover {
            background: var(--dark-border);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .light-mode .download-option:hover {
            background: var(--light-border);
        }
        
        .download-option i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .download-option h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .light-mode .download-option h3 {
            color: var(--light-text);
        }
        
        .download-option p {
            font-size: 0.85rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .download-option p {
            color: var(--light-text-secondary);
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--dark-border);
            text-align: center;
        }
        
        .light-mode .modal-footer {
            border-top-color: var(--light-border);
        }
        
        .modal-footer p {
            font-size: 0.85rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .modal-footer p {
            color: var(--light-text-secondary);
        }
        
        /* Progress indicator */
        .progress-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
        }
        
        .progress-indicator.active {
            display: flex;
        }
        
        .progress-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--dark-border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .light-mode .progress-spinner {
            border-color: var(--light-border);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Delete confirmation modal */
        .confirmation-modal {
            max-width: 400px;
        }
        
        .confirmation-text {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .confirmation-text i {
            font-size: 3rem;
            color: var(--error);
            margin-bottom: 1rem;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .confirmation-btn {
            flex: 1;
            padding: 0.8rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .confirmation-btn.cancel {
            background: var(--dark-surface-light);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
        }
        
        .light-mode .confirmation-btn.cancel {
            background: var(--light-surface-light);
            color: var(--light-text);
            border-color: var(--light-border);
        }
        
        .confirmation-btn.cancel:hover {
            background: var(--dark-border);
        }
        
        .light-mode .confirmation-btn.cancel:hover {
            background: var(--light-border);
        }
        
        .confirmation-btn.delete {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
        }
        
        .confirmation-btn.delete:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Language hint */
        .language-hint {
            position: absolute;
            top: -25px;
            left: 10px;
            font-size: 0.8rem;
            color: var(--primary);
            background: var(--dark-surface);
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid var(--primary);
            z-index: 1;
            display: none;
        }
        
        .light-mode .language-hint {
            background: var(--light-surface);
        }
        
        /* Legal Content */
        .legal-note {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.8rem 0;
            font-size: 0.85rem;
            color: var(--warning);
            word-wrap: break-word;
        }
        
        .light-mode .legal-note {
            background: rgba(245, 158, 11, 0.08);
            border-color: rgba(245, 158, 11, 0.2);
        }
        
        .legal-content {
            line-height: 1.7;
            word-wrap: break-word;
        }
        
        .legal-content h3 {
            color: var(--primary);
            margin: 1.2rem 0 0.6rem 0;
            font-size: 1.1rem;
            word-wrap: break-word;
        }
        
        .legal-content ul {
            margin: 0.8rem 0 0.8rem 1.2rem;
            list-style-type: disc;
        }
        
        .legal-content li {
            margin-bottom: 0.4rem;
            word-wrap: break-word;
        }
        
        .legal-content strong {
            color: var(--primary-light);
        }
        
        /* Input area with language hint */
        .input-area {
            position: relative;
        }
        
        /* Document Draft Templates */
        .draft-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .draft-template {
            background: var(--dark-surface-light);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 10px;
            word-wrap: break-word;
        }
        
        .light-mode .draft-template {
            background: var(--light-surface-light);
            border-color: var(--light-border);
        }
        
        .draft-template:hover {
            background: var(--dark-border);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .light-mode .draft-template:hover {
            background: var(--light-border);
        }
        
        .draft-template i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .draft-template h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .light-mode .draft-template h4 {
            color: var(--light-text);
        }
        
        .draft-template p {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
        }
        
        .light-mode .draft-template p {
            color: var(--light-text-secondary);
        }
        
        /* Responsive Breakpoints */
        
        /* Mobile - Small Screens (up to 480px) */
        @media (max-width: 480px) {
            header {
                padding: 0.8rem 0.8rem;
                min-height: 60px;
            }
            
            .logo h1 {
                font-size: 1.1rem;
            }
            
            .header-btn span {
                display: none;
            }
            
            .header-btn i {
                margin: 0;
            }
            
            .status-indicator span {
                display: none;
            }
            
            .chat-messages {
                padding: 0.8rem;
            }
            
            .message-content {
                max-width: 90%;
            }
            
            .document-download-btn {
                opacity: 1;
                transform: translateY(0);
                top: -10px;
                right: 5px;
                padding: 4px 8px;
                font-size: 0.6rem;
            }
            
            .welcome-message {
                padding: 1rem;
                margin: 1rem auto;
            }
            
            .welcome-message h2 {
                font-size: 1.5rem;
            }
            
            .welcome-features {
                grid-template-columns: 1fr;
            }
            
            .input-container {
                padding: 0.8rem;
            }
            
            .input-area textarea {
                padding: 0.8rem 6.5rem 0.8rem 1rem;
                font-size: 0.95rem;
                min-height: 52px;
            }
            
            .input-buttons {
                right: 0.6rem;
                bottom: 0.6rem;
                gap: 6px;
            }
            
            .send-button {
                padding: 0.5rem 0.8rem;
                min-height: 40px;
            }
            
            .input-microphone-btn {
                width: 32px;
                height: 32px;
                padding: 0.4rem;
            }
            
            .attachment-btn {
                width: 32px;
                height: 32px;
                padding: 0.4rem;
            }
            
            .sidebar {
                width: 85vw;
                max-width: 300px;
            }
            
            .download-options {
                grid-template-columns: 1fr;
            }
            
            .history-item-actions {
                display: flex !important;
                opacity: 0.9;
            }
            
            .document-template {
                padding: 1rem;
            }
            
            .signature-line {
                flex-direction: column;
                gap: 1rem;
            }
            
            .message-text {
                padding: 0.8rem 1rem;
            }
            
            .attachment-item {
                max-width: 150px;
            }
        }
        
        /* Mobile - Medium Screens (481px to 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            .header-btn span {
                display: none;
            }
            
            .status-indicator {
                padding: 0.4rem;
            }
            
            .status-indicator span {
                display: none;
            }
            
            .document-download-btn {
                opacity: 1;
                transform: translateY(0);
            }
            
            .welcome-features {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-item-actions {
                display: flex !important;
                opacity: 0.9;
            }
            
            .input-area textarea {
                padding: 1rem 7rem 1rem 1.2rem;
            }
            
            .sidebar {
                width: 85vw;
                max-width: 320px;
            }
        }
        
        /* Tablet (768px to 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
                width: 320px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .chat-container {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .header-btn {
                padding: 0.6rem 1rem;
            }
            
            .welcome-features {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .message-content {
                max-width: 80%;
            }
        }
        
        /* Desktop (1024px and above) */
        @media (min-width: 1024px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
                flex-shrink: 0;
            }
            
            .sidebar-toggle {
                display: none;
            }
            
            .sidebar-close {
                display: none;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
            
            .chat-messages {
                padding: 1.5rem 2rem;
            }
            
            .input-container {
                padding: 1.5rem;
            }
            
            .welcome-message {
                margin: 3rem auto;
                padding: 2rem;
            }
            
            .welcome-message h2 {
                font-size: 2.2rem;
            }
            
            .main-content {
                overflow: hidden;
            }
        }
        
        /* Large Desktop Screens */
        @media (min-width: 1440px) {
            .container {
                max-width: 1600px;
                margin: 0 auto;
            }
            
            .chat-messages {
                padding: 2rem 3rem;
            }
            
            .message-content {
                max-width: 70%;
            }
            
            .sidebar {
                width: 300px;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }
        
        .light-mode ::-webkit-scrollbar-track {
            background: var(--light-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
            border-radius: 4px;
        }
        
        .light-mode ::-webkit-scrollbar-thumb {
            background: var(--light-border);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-surface-light);
        }
        
        .light-mode ::-webkit-scrollbar-thumb:hover {
            background: var(--light-surface-light);
        }
        
        /* Enhanced UI Elements */
        .legal-card {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            transition: all 0.3s;
            word-wrap: break-word;
        }
        
        .light-mode .legal-card {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        .legal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .legal-card-title {
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legal-card-content {
            color: var(--dark-text-secondary);
            line-height: 1.6;
        }
        
        .light-mode .legal-card-content {
            color: var(--light-text-secondary);
        }
        
        /* Law References */
        .law-reference {
            background: rgba(16, 163, 127, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
            word-wrap: break-word;
        }
        
        .light-mode .law-reference {
            background: rgba(16, 163, 127, 0.08);
        }
        
        .law-reference-title {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .law-reference-content {
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
        }
        
        .light-mode .law-reference-content {
            color: var(--light-text-secondary);
        }
        
        /* Professional UI Enhancements */
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--dark-border), transparent);
            margin: 2rem 0;
        }
        
        .light-mode .section-divider {
            background: linear-gradient(90deg, transparent, var(--light-border), transparent);
        }
        
        /* Utility Classes */
        .hide-on-mobile {
            display: none;
        }
        
        .show-on-mobile {
            display: flex;
        }
        
        @media (min-width: 768px) {
            .hide-on-mobile {
                display: flex;
            }
            
            .show-on-mobile {
                display: none;
            }
        }
        
        /* Voice Animation */
        .voice-animation {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 20px;
        }
        
        .voice-bar {
            width: 3px;
            background: var(--primary);
            border-radius: 3px;
            animation: voicePulse 0.8s ease-in-out infinite;
        }
        
        .voice-bar:nth-child(1) {
            height: 8px;
            animation-delay: 0.1s;
        }
        
        .voice-bar:nth-child(2) {
            height: 12px;
            animation-delay: 0.2s;
        }
        
        .voice-bar:nth-child(3) {
            height: 16px;
            animation-delay: 0.3s;
        }
        
        .voice-bar:nth-child(4) {
            height: 12px;
            animation-delay: 0.4s;
        }
        
        .voice-bar:nth-child(5) {
            height: 8px;
            animation-delay: 0.5s;
        }
        
        @keyframes voicePulse {
            0%, 100% {
                opacity: 0.4;
                transform: scaleY(0.8);
            }
            50% {
                opacity: 1;
                transform: scaleY(1.2);
            }
        }
        
        /* Voice Input Text */
        .voice-input-text {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.85rem;
            color: var(--primary);
            font-style: italic;
            padding: 5px;
            background: rgba(16, 163, 127, 0.1);
            border-radius: 8px;
            animation: slideUp 0.3s ease;
            display: none;
        }
        
        .light-mode .voice-input-text {
            background: rgba(16, 163, 127, 0.08);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Input Microphone Animation */
        .input-microphone-btn.listening .fa-microphone {
            animation: micPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes micPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        /* Improved responsive behavior */
        @media (max-height: 600px) {
            header {
                min-height: 56px;
                padding: 0.6rem 1rem;
            }
            
            .header-btn {
                min-height: 36px;
                padding: 0.4rem 0.6rem;
            }
            
            .voice-search-btn,
            .theme-toggle,
            .sidebar-toggle {
                width: 40px;
                height: 40px;
            }
            
            .chat-messages {
                padding: 0.6rem;
            }
            
            .input-container {
                padding: 0.6rem;
            }
            
            .input-area textarea {
                min-height: 48px;
                padding: 0.8rem 6rem 0.8rem 1rem;
            }
            
            .send-button {
                min-height: 36px;
                padding: 0.4rem 0.8rem;
            }
            
            .attachment-btn,
            .input-microphone-btn {
                width: 32px;
                height: 32px;
            }
        }
        
        /* NEW STYLES FOR IMAGE ATTACHMENT FUNCTIONALITY */
        
        /* 1. Down Arrow Button (Scroll to Bottom) - FIXED FOR MOBILE */
        .scroll-to-bottom-btn {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 44px;
            height: 44px;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 50%;
            color: var(--dark-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(20px);
        }
        
        @media (max-width: 767px) {
            .scroll-to-bottom-btn {
                bottom: 90px;
                right: 15px;
                width: 40px;
                height: 40px;
            }
        }
        
        .light-mode .scroll-to-bottom-btn {
            background: var(--light-surface);
            border-color: var(--light-border);
            color: var(--light-text);
        }
        
        .scroll-to-bottom-btn.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .scroll-to-bottom-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(16, 163, 127, 0.3);
        }
        
        /* 2. User Message Controls */
        .user-message-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 5;
        }
        
        .user-message:hover .user-message-controls {
            opacity: 1;
        }
        
        .user-message-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 28px;
            min-height: 28px;
            justify-content: center;
        }
        
        .user-message-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .user-message-btn.copy-btn {
            background: rgba(16, 163, 127, 0.3);
            border: 1px solid rgba(16, 163, 127, 0.5);
        }
        
        .user-message-btn.copy-btn:hover {
            background: rgba(16, 163, 127, 0.5);
        }
        
        .user-message-btn.edit-btn {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        
        .user-message-btn.edit-btn:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        /* Square Copy Button */
        .square-copy-btn {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        /* Stream Controls */
        .stream-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding: 0 8px;
        }
        
        .stream-control-btn {
            background: var(--dark-surface-light);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--dark-text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .light-mode .stream-control-btn {
            background: var(--light-surface-light);
            border-color: var(--light-border);
            color: var(--light-text-secondary);
        }
        
        .stream-control-btn:hover {
            background: var(--dark-border);
            color: var(--dark-text);
        }
        
        .light-mode .stream-control-btn:hover {
            background: var(--light-border);
            color: var(--light-text);
        }
        
        .stream-control-btn.pause-btn:hover {
            background: var(--warning);
            border-color: var(--warning);
            color: white;
        }
        
        .stream-control-btn.copy-btn:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        /* Response Pause/Continue */
        .response-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            margin-left: 3rem;
        }
        
        /* Scroll Position Indicator */
        .scroll-position-indicator {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-surface);
            color: var(--dark-text-secondary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid var(--dark-border);
            display: none;
            z-index: 10;
        }
        
        .light-mode .scroll-position-indicator {
            background: var(--light-surface);
            color: var(--light-text-secondary);
            border-color: var(--light-border);
        }
        
        .scroll-position-indicator.visible {
            display: block;
        }
        
        /* Image Upload Modal */
        .image-upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .image-upload-modal.active {
            display: flex;
        }
        
        .image-upload-content {
            background: var(--dark-surface);
            border-radius: 16px;
            border: 1px solid var(--dark-border);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .light-mode .image-upload-content {
            background: var(--light-surface);
            border-color: var(--light-border);
        }
        
        .upload-area {
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            border: 2px dashed var(--dark-border);
            border-radius: 12px;
            margin: 1.5rem;
            transition: all 0.3s;
        }
        
        .light-mode .upload-area {
            border-color: var(--light-border);
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(16, 163, 127, 0.05);
        }
        
        .light-mode .upload-area:hover {
            background: rgba(16, 163, 127, 0.02);
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(16, 163, 127, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .upload-text h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--dark-text);
        }
        
        .light-mode .upload-text h3 {
            color: var(--light-text);
        }
        
        .upload-text p {
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .light-mode .upload-text p {
            color: var(--light-text-secondary);
        }
        
        .upload-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        .uploaded-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .uploaded-image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--dark-border);
        }
        
        .light-mode .uploaded-image-item {
            border-color: var(--light-border);
        }
        
        .uploaded-image-preview {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        
        .remove-uploaded-image {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        /* Share Button for Images */
        .share-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(16, 163, 127, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 2;
        }
        
        .share-btn:hover {
            background: rgba(16, 163, 127, 1);
        }
        
        /* AI Response Streaming Styles */
        .streaming-content {
            min-height: 20px;
        }
        
        .streaming-cursor {
            display: inline-block;
            width: 8px;
            height: 20px;
            background-color: var(--primary);
            margin-left: 4px;
            vertical-align: middle;
            animation: cursorBlink 1s infinite;
        }
        
        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Loading animation for streaming */
        .streaming-loader {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }
        
        .streaming-loader .dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary);
            border-radius: 50%;
            animation: streamingDots 1.4s infinite ease-in-out both;
        }
        
        .streaming-loader .dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .streaming-loader .dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes streamingDots {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Request specific styles */
        .request-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        /* ChatGPT-like message styling */
        .message-text p {
            margin-bottom: 0.5rem;
        }
        
        .message-text p:last-child {
            margin-bottom: 0;
        }
        
        .message-text ul, .message-text ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .message-text li {
            margin-bottom: 0.25rem;
        }
        
        /* Pause state indicator */
        .paused-indicator {
            display: inline-block;
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        /* Keep user at top during streaming */
        .user-position-fixed {
            position: relative;
            top: 0;
            margin-bottom: 10px;
        }
        
    </style>
</head>
<body class="dark-mode">
    <!-- Login Modal -->
    <div class="login-modal-overlay" id="loginModal">
        <div class="login-modal">
            <div class="login-header">
                <div class="login-icon">
                    <i class="fas fa-scale-balanced"></i>
                </div>
                <h2>Welcome to LegalSwami</h2>
                <p>Your AI-powered legal assistant</p>
            </div>
            
            <div class="login-content">
                <div class="login-features">
                    <div class="login-feature">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <h4>Secure & Private</h4>
                            <p>Your conversations are encrypted and confidential</p>
                        </div>
                    </div>
                    <div class="login-feature">
                        <i class="fas fa-sync-alt"></i>
                        <div>
                            <h4>Sync Across Devices</h4>
                            <p>Access your chat history anywhere</p>
                        </div>
                    </div>
                    <div class="login-feature">
                        <i class="fas fa-download"></i>
                        <div>
                            <h4>Document Download</h4>
                            <p>Save legal documents for offline use</p>
                        </div>
                    </div>
                </div>
                
                <button class="google-login-btn" id="googleLoginBtn">
                    <i class="fab fa-google"></i>
                    <span>Continue with Google</span>
                </button>
                
                <!-- Google Sign In Button Container -->
                <div id="googleSignInContainer" style="display: none;"></div>
            </div>
            
            <div class="login-footer">
                <p>By continuing, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container (Hidden until login) -->
    <div class="container" id="appContainer" style="display: none;">
        <header>
            <div class="logo">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-icon">
                    <i class="fas fa-scale-balanced"></i>
                </div>
                <h1>LegalSwami</h1>
            </div>
            
            <div class="header-actions">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span class="hide-on-mobile">AI Assistant Ready</span>
                </div>
                
                <button class="header-btn voice-search-btn" id="voiceSearchBtn" title="Voice Search">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="header-btn theme-toggle" id="themeToggle" title="Toggle Theme">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="header-btn" id="clearChatBtn">
                    <i class="fas fa-broom"></i>
                    <span class="hide-on-mobile">Clear Chat</span>
                    <span class="show-on-mobile">Clear</span>
                </button>
                <button class="header-btn" id="downloadCurrentBtn">
                    <i class="fas fa-download"></i>
                    <span class="hide-on-mobile">Download Chat</span>
                </button>
                <button class="header-btn" id="suggestionsBtn">
                    <i class="fas fa-lightbulb"></i>
                    <span class="hide-on-mobile">Suggestions</span>
                    <span class="show-on-mobile">Tips</span>
                </button>
                
                <!-- User Profile (Replaces login button) -->
                <div class="user-profile" id="userProfile">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Guest</div>
                        <div class="user-email" id="userEmail">Not signed in</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                </div>
            </div>
        </header>
        
        <!-- User Dropdown Menu -->
        <div class="user-dropdown" id="userDropdown">
            <div class="dropdown-header">
                <div class="user-avatar" id="dropdownAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="dropdownName">Guest</div>
                    <div class="user-email" id="dropdownEmail">Not signed in</div>
                </div>
            </div>
            
            <div class="dropdown-items">
                <button class="dropdown-item" id="profileBtn">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </button>
                <button class="dropdown-item" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
                <button class="dropdown-item" id="historyBtn">
                    <i class="fas fa-history"></i>
                    <span>Chat History</span>
                </button>
                <button class="dropdown-item" id="helpBtn">
                    <i class="fas fa-question-circle"></i>
                    <span>Help & Support</span>
                </button>
                <div class="dropdown-footer">
                    <button class="dropdown-item logout" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Down Arrow Button (Scroll to Bottom) -->
            <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to bottom">
                <i class="fas fa-chevron-down"></i>
            </button>
            
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <aside class="sidebar" id="sidebar">
                <!-- Sidebar Close Button -->
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- Sidebar Tabs -->
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="legal-topics">
                        <i class="fas fa-book"></i>
                        <span class="hide-on-mobile">Legal Topics</span>
                        <span class="show-on-mobile">Topics</span>
                    </button>
                    <button class="sidebar-tab" data-tab="chat-history">
                        <i class="fas fa-history"></i>
                        <span class="hide-on-mobile">Chat History</span>
                        <span class="show-on-mobile">History</span>
                    </button>
                </div>
                
                <!-- Legal Topics Tab Content -->
                <div class="tab-content active" id="legal-topics-content">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-book"></i> Legal Topics</h2>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="topic-list">
                            <div class="topic-item" data-topic="contract">
                                <i class="fas fa-file-contract"></i>
                                <span>Contract Law</span>
                            </div>
                            <div class="topic-item" data-topic="employment">
                                <i class="fas fa-briefcase"></i>
                                <span>Employment Law</span>
                            </div>
                            <div class="topic-item" data-topic="intellectual">
                                <i class="fas fa-lightbulb"></i>
                                <span>Intellectual Property</span>
                            </div>
                            <div class="topic-item" data-topic="realestate">
                                <i class="fas fa-house"></i>
                                <span>Real Estate Law</span>
                            </div>
                            <div class="topic-item" data-topic="family">
                                <i class="fas fa-heart"></i>
                                <span>Family Law</span>
                            </div>
                            <div class="topic-item" data-topic="criminal">
                                <i class="fas fa-gavel"></i>
                                <span>Criminal Law</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                        <div class="quick-actions">
                            <div class="action-item" data-action="document-drafts">
                                <i class="fas fa-file-alt"></i>
                                <span>Document Drafts</span>
                            </div>
                            <div class="action-item" data-action="legal-research">
                                <i class="fas fa-search"></i>
                                <span>Legal Research</span>
                            </div>
                            <div class="action-item" data-action="case-analysis">
                                <i class="fas fa-chart-bar"></i>
                                <span>Case Analysis</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3><i class="fas fa-language"></i> Language Support</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            <span style="background: rgba(16, 163, 127, 0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;">English</span>
                            <span style="background: rgba(16, 163, 127, 0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;"></span>
                            <span style="background: rgba(16, 163, 127, 0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;"></span>
                            <span style="background: rgba(16, 163, 127, 0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem;"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Chat History Tab Content -->
                <div class="tab-content" id="chat-history-content">
                    <div class="history-header">
                        <h2><i class="fas fa-history"></i> Chat History</h2>
                        <button class="new-chat-btn" id="newChatBtn">
                            <i class="fas fa-plus"></i>
                            <span class="hide-on-mobile">New Chat</span>
                            <span class="show-on-mobile">New</span>
                        </button>
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <!-- History items will be loaded here -->
                        <div class="empty-history">
                            <i class="fas fa-comments"></i>
                            <p>No chat history yet</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Start a conversation to see it here</p>
                        </div>
                    </div>
                </div>
            </aside>
            
            <main class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <h2>Welcome to LegalSwami</h2>
                        <p>Your AI-powered legal assistant for accurate, comprehensive legal information and guidance.</p>
                        <p style="color: var(--primary); margin-top: 10px; font-size: 0.9rem;">
                            <i class="fas fa-language"></i> Supports multiple Indian languages including Marathi, Hindi, and more!
                        </p>
                        
                        <div style="margin-top: 2rem;">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">Ready-to-Use Legal Documents:</h3>
                            <div class="draft-templates">
                                <div class="draft-template" data-template="nda">
                                    <i class="fas fa-file-signature"></i>
                                    <h4>Non-Disclosure Agreement</h4>
                                    <p>Confidentiality agreement template</p>
                                </div>
                                <div class="draft-template" data-template="employment">
                                    <i class="fas fa-briefcase"></i>
                                    <h4>Employment Contract</h4>
                                    <p>Employee agreement template</p>
                                </div>
                                <div class="draft-template" data-template="rental">
                                    <i class="fas fa-house"></i>
                                    <h4>Rental Agreement</h4>
                                    <p>Tenancy agreement template</p>
                                </div>
                                <div class="draft-template" data-template="loan">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <h4>Loan Agreement</h4>
                                    <p>Money lending agreement</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section-divider"></div>
                        
                        <div class="welcome-features">
                            <div class="feature">
                                <i class="fas fa-bolt"></i>
                                <h4>Instant Responses</h4>
                                <p>Get immediate legal insights powered by advanced AI</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-shield-alt"></i>
                                <h4>Confidential & Secure</h4>
                                <p>Your conversations are private and encrypted</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-language"></i>
                                <h4>Multi-Language</h4>
                                <p>Responds in same language as your query</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-microphone"></i>
                                <h4>Voice Search</h4>
                                <p>Speak your queries in natural language</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scroll Position Indicator -->
                <div class="scroll-position-indicator" id="scrollPositionIndicator">
                    Scroll to see more messages
                </div>
                
                <div class="input-container">
                    <div class="input-area">
                        <!-- Attachments Preview -->
                        <div class="attachments-preview" id="attachmentsPreview" style="display: none;"></div>
                        
                        <div class="voice-input-status" id="voiceInputStatus">
                            <div class="voice-animation">
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                            </div>
                            <span>Listening... Speak now</span>
                        </div>
                        
                        <textarea 
                            id="userInput" 
                            placeholder="Ask any legal question or request a document draft... (Press Enter for new line, Ctrl+Enter to send)"
                            rows="1"
                        ></textarea>
                        
                        <div class="voice-input-text" id="voiceInputText"></div>
                        
                        <div class="input-buttons">
                            <!-- Attachment Button -->
                            <button class="attachment-btn" id="attachmentBtn" title="Attach files">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            
                            <!-- Voice Input Button -->
                            <button class="input-microphone-btn" id="inputMicrophoneBtn" title="Voice input">
                                <i class="fas fa-microphone"></i>
                            </button>
                            
                            <!-- Send Button -->
                            <button class="send-button" id="sendButton">
                                <i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Download Modal (for full chat) -->
        <div class="modal-overlay" id="downloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-download"></i> Download Chat</h2>
                    <button class="modal-close" id="closeDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format you want to download your chat in:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="progressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include the complete chat conversation with timestamps.</p>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay" id="deleteModal">
            <div class="modal confirmation-modal">
                <div class="modal-header">
                    <h2><i class="fas fa-trash"></i> Delete Chat</h2>
                    <button class="modal-close" id="closeDeleteModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="confirmation-text">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Are you sure you want to delete this chat?</h3>
                        <p id="deleteChatTitle">This action cannot be undone and the chat will be permanently deleted.</p>
                    </div>
                    
                    <div class="confirmation-buttons">
                        <button class="confirmation-btn cancel" id="cancelDelete">Cancel</button>
                        <button class="confirmation-btn delete" id="confirmDelete">Delete Permanently</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Individual Message Download Modal -->
        <div class="modal-overlay" id="messageDownloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-file-download"></i> Download Document</h2>
                    <button class="modal-close" id="closeMessageDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format for this specific response:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="messageProgressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include only this specific AI response.</p>
                </div>
            </div>
        </div>
        
        <!-- Image Upload Modal -->
        <div class="modal-overlay image-upload-modal" id="imageUploadModal">
            <div class="image-upload-content">
                <div class="modal-header">
                    <h2><i class="fas fa-image"></i> Attach Images</h2>
                    <button class="modal-close" id="closeImageUploadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h3>Drag & Drop Images Here</h3>
                            <p>or click to browse files</p>
                            <p style="font-size: 0.8rem; color: var(--dark-text-secondary);">
                                Supported formats: JPG, PNG, GIF, WEBP
                            </p>
                            <button class="upload-btn" id="browseFilesBtn">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <div class="uploaded-images" id="uploadedImages">
                        <!-- Uploaded images will appear here -->
                    </div>
                    
                    <div class="confirmation-buttons" style="margin-top: 1.5rem;">
                        <button class="confirmation-btn cancel" id="cancelImageUpload">
                            Cancel
                        </button>
                        <button class="confirmation-btn" id="confirmImageUpload" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                            <i class="fas fa-paperclip"></i> Attach Selected Images
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">Message sent successfully</span>
        </div>
    </div>

    <script>
        // Your Groq API Key
        const GROQ_API_KEY = "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";
        
        // Your Google Client ID
        const GOOGLE_CLIENT_ID = "166511615962-bohur5q8d4i5hud6icr4185kcte9enk8.apps.googleusercontent.com";
        
        // Working models
        const WORKING_MODELS = [
            "allam-2-7b",
            "meta-llama/llama-4-maverick-17b-128e-instruct",
            "openai/gpt-oss-safeguard-20b",
            "playai-tts-arabic",
            "meta-llama/llama-prompt-guard-2-86m",
            "meta-llama/llama-4-scout-17b-16e-instruct",
            "openai/gpt-oss-20b",
            "openai/gpt-oss-120b",
            "groq/compound-mini",
            "llama-3.1-8b-instant",
            "moonshotai/kimi-k2-instruct-0905",
            "playai-tts",
            "llama-3.3-70b-versatile",
            "qwen/qwen3-32b",
            "groq/compound",
            "meta-llama/llama-guard-4-12b",
            "moonshotai/kimi-k2-instruct",
            "meta-llama/llama-prompt-guard-2-22m",
            "llama3-8b-8192",
            "llama3-70b-8192",
            "mixtral-8x7b-32768"
        ];
        
        // Current model
        let currentModel = "openai/gpt-oss-safeguard-20b";
        
        // Chat History Management
        let chatHistory = []; // Array of chat sessions
        let currentChatId = null; // ID of current chat session
        let conversationHistory = []; // Messages in current chat
        
        // Store message content for document download
        let messageContentForDownload = "";
        
        // Voice recognition
        let isListening = false;
        let recognition = null;
        let isInputMicrophoneActive = false;
        
        // Theme management
        let isLightMode = false;
        
        // Streaming response management
        let currentStreamingMessageId = null;
        let currentStreamingContent = '';
        let currentStreamingBuffer = '';
        let streamingTextChunks = [];
        let streamingTextIndex = 0;
        let streamingWordDelay = 20; // milliseconds between words
        let streamingPunctuationDelay = 100; // extra delay for punctuation
        
        // Image attachments management
        let attachedImages = []; // Array to store attached images
        let selectedImages = []; // Array for image upload modal
        
        // Streaming control
        let isStreamingPaused = false;
        
        // User Management
        let currentUser = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            checkLoginStatus();
            
            // Initialize Google Identity Services
            initializeGoogleSignIn();
            
            // Event listeners for login
            document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('userProfile').addEventListener('click', toggleUserDropdown);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const userDropdown = document.getElementById('userDropdown');
                const userProfile = document.getElementById('userProfile');
                
                if (!userProfile.contains(event.target) && !userDropdown.contains(event.target)) {
                    userDropdown.classList.remove('active');
                }
            });
            
            // Other event listeners remain the same...
            // ... (all your existing initialization code) ...
            
        });
        
        // Initialize Google Sign In
        function initializeGoogleSignIn() {
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true,
                    context: 'signin',
                    ux_mode: 'popup',
                    login_uri: window.location.origin
                });
            }
        }
        
        // Handle Google Login Button Click
        function handleGoogleLogin() {
            const loginBtn = document.getElementById('googleLoginBtn');
            loginBtn.classList.add('loading');
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Loading...</span>';
            
            if (typeof google !== 'undefined') {
                google.accounts.id.prompt((notification) => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        // If One Tap is not displayed, show the standard button
                        renderGoogleSignInButton();
                        loginBtn.classList.remove('loading');
                        loginBtn.innerHTML = '<i class="fab fa-google"></i><span>Continue with Google</span>';
                    }
                });
                
                // Also render the button as fallback
                renderGoogleSignInButton();
            } else {
                showToast('Google Sign-In service is unavailable. Please try again later.', 'error');
                loginBtn.classList.remove('loading');
                loginBtn.innerHTML = '<i class="fab fa-google"></i><span>Continue with Google</span>';
            }
        }
        
        // Render Google Sign In Button
        function renderGoogleSignInButton() {
            const container = document.getElementById('googleSignInContainer');
            container.innerHTML = '';
            
            google.accounts.id.renderButton(
                container,
                {
                    type: 'standard',
                    theme: 'filled_blue',
                    size: 'large',
                    text: 'signin_with',
                    shape: 'rectangular',
                    logo_alignment: 'left',
                    width: 400
                }
            );
            
            // Also add the "One Tap" prompt
            google.accounts.id.prompt();
        }
        
        // Handle Credential Response from Google
        function handleCredentialResponse(response) {
            console.log("Google login response received");
            
            // Decode the JWT token to get user info
            const responsePayload = decodeJWTResponse(response.credential);
            
            if (responsePayload) {
                // Store user information
                currentUser = {
                    id: responsePayload.sub,
                    name: responsePayload.name,
                    email: responsePayload.email,
                    picture: responsePayload.picture,
                    verified: responsePayload.email_verified
                };
                
                // Save to localStorage
                localStorage.setItem('legalSwamiUser', JSON.stringify(currentUser));
                
                // Update UI
                updateUserUI();
                
                // Hide login modal and show app
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('appContainer').style.display = 'flex';
                
                // Show welcome message
                showToast(`Welcome to LegalSwami, ${currentUser.name}!`, 'success');
                
                // Initialize chat functionality
                initializeChatApp();
                
                // Load user's chat history
                loadUserChatHistory();
            } else {
                showToast('Failed to login with Google. Please try again.', 'error');
            }
        }
        
        // Decode JWT Response
        function decodeJWTResponse(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding JWT:', error);
                return null;
            }
        }
        
        // Check Login Status
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('legalSwamiUser');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    // Check if token is still valid (basic check)
                    if (currentUser && currentUser.email) {
                        // User is logged in
                        document.getElementById('loginModal').classList.remove('active');
                        document.getElementById('appContainer').style.display = 'flex';
                        updateUserUI();
                        initializeChatApp();
                        loadUserChatHistory();
                        return;
                    }
                } catch (error) {
                    console.error('Error parsing user data:', error);
                }
            }
            
            // User is not logged in, show login modal
            document.getElementById('loginModal').classList.add('active');
        }
        
        // Update User UI
        function updateUserUI() {
            if (!currentUser) return;
            
            // Update avatar
            const avatar = document.getElementById('userAvatar');
            const dropdownAvatar = document.getElementById('dropdownAvatar');
            
            if (currentUser.picture) {
                avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}">`;
                dropdownAvatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}">`;
            } else {
                // Use initials if no picture
                const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                avatar.innerHTML = initials;
                dropdownAvatar.innerHTML = initials;
            }
            
            // Update name and email
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('dropdownName').textContent = currentUser.name;
            document.getElementById('dropdownEmail').textContent = currentUser.email;
        }
        
        // Toggle User Dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }
        
        // Handle Logout
        function handleLogout() {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear user data
                currentUser = null;
                localStorage.removeItem('legalSwamiUser');
                
                // Clear chat data
                chatHistory = [];
                conversationHistory = [];
                currentChatId = null;
                localStorage.removeItem('legalSwamiChatHistory');
                localStorage.removeItem('legalSwamiCurrentChatId');
                
                // Hide dropdown
                document.getElementById('userDropdown').classList.remove('active');
                
                // Hide app and show login modal
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('loginModal').classList.add('active');
                
                // Reset login button
                const loginBtn = document.getElementById('googleLoginBtn');
                loginBtn.classList.remove('loading');
                loginBtn.innerHTML = '<i class="fab fa-google"></i><span>Continue with Google</span>';
                
                // Show toast
                showToast('Signed out successfully', 'info');
                
                // If Google library is loaded, sign out from Google
                if (typeof google !== 'undefined') {
                    google.accounts.id.disableAutoSelect();
                }
            }
        }
        
        // Load User's Chat History
        function loadUserChatHistory() {
            // In a real app, you would fetch from server based on user ID
            // For now, we'll use localStorage with user-specific key
            const userId = currentUser ? currentUser.id : 'guest';
            const storageKey = `legalSwamiChatHistory_${userId}`;
            
            try {
                const savedHistory = localStorage.getItem(storageKey);
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                }
                
                const savedChatId = localStorage.getItem(`legalSwamiCurrentChatId_${userId}`);
                if (savedChatId) {
                    currentChatId = savedChatId;
                    // Load the current chat's messages
                    const currentChat = chatHistory.find(chat => chat.id === currentChatId);
                    if (currentChat) {
                        conversationHistory = [...currentChat.messages];
                    }
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                chatHistory = [];
            }
        }
        
        // Save User's Chat History
        function saveUserChatHistory() {
            if (!currentUser) return;
            
            const userId = currentUser.id;
            const storageKey = `legalSwamiChatHistory_${userId}`;
            
            try {
                localStorage.setItem(storageKey, JSON.stringify(chatHistory));
                localStorage.setItem(`legalSwamiCurrentChatId_${userId}`, currentChatId);
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }
        
        // Initialize Chat App (after login)
        function initializeChatApp() {
            // Your existing initialization code for chat functionality
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const downloadCurrentBtn = document.getElementById('downloadCurrentBtn');
            const suggestionsBtn = document.getElementById('suggestionsBtn');
            const voiceSearchBtn = document.getElementById('voiceSearchBtn');
            const inputMicrophoneBtn = document.getElementById('inputMicrophoneBtn');
            const themeToggle = document.getElementById('themeToggle');
            const topicItems = document.querySelectorAll('.topic-item');
            const actionItems = document.querySelectorAll('.action-item');
            const sidebarTabs = document.querySelectorAll('.sidebar-tab');
            const newChatBtn = document.getElementById('newChatBtn');
            const draftTemplates = document.querySelectorAll('.draft-template');
            const attachmentBtn = document.getElementById('attachmentBtn');
            
            // Set initial state based on screen size
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop) {
                sidebar.classList.add('active');
            }
            
            // Load theme preference
            loadThemePreference();
            
            // Create new chat if no current chat
            if (!currentChatId) {
                createNewChat();
            }
            
            // Event listeners (same as before, but now initialized after login)
            sendButton.addEventListener('click', sendMessage);
            
            // FIX 1: Updated Enter key behavior - Enter for new line, Ctrl+Enter to send
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                }
                // Enter without Ctrl - just add new line
                if (e.key === 'Enter' && !e.ctrlKey) {
                    // Allow default behavior (new line)
                    // Auto-expand textarea
                    setTimeout(() => {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                    }, 10);
                }
            });
            
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                sendButton.disabled = this.value.trim() === '' && attachedImages.length === 0;
                
                // Show language detection hint
                const text = this.value.trim();
                if (text.length > 0) {
                    const lang = detectLanguage(text);
                    showLanguageHint(lang);
                } else {
                    hideLanguageHint();
                }
            });
            
            // Voice search functionality
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-IN,hi-IN,mr-IN,ta-IN,te-IN';
                
                recognition.onstart = function() {
                    isListening = true;
                    if (isInputMicrophoneActive) {
                        inputMicrophoneBtn.classList.add('listening');
                    } else {
                        voiceSearchBtn.classList.add('listening');
                    }
                    document.getElementById('voiceInputStatus').classList.add('active');
                    showToast('Listening... Speak now', 'info');
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const voiceInputText = document.getElementById('voiceInputText');
                    
                    if (event.results[0].isFinal) {
                        userInput.value = transcript;
                        userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
                        voiceInputText.style.display = 'none';
                        
                        // Auto-detect language and show hint
                        const lang = detectLanguage(transcript);
                        showLanguageHint(lang);
                        
                        // Auto-send after 1 second for short queries
                        if (transcript.split(' ').length <= 10) {
                            setTimeout(() => {
                                sendMessage();
                            }, 1000);
                        }
                    } else {
                        voiceInputText.textContent = transcript;
                        voiceInputText.style.display = 'block';
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    isInputMicrophoneActive = false;
                    inputMicrophoneBtn.classList.remove('listening');
                    voiceSearchBtn.classList.remove('listening');
                    document.getElementById('voiceInputStatus').classList.remove('active');
                    
                    if (event.error === 'not-allowed') {
                        showToast('Microphone access denied. Please allow microphone access.', 'error');
                    } else {
                        showToast('Voice recognition failed. Please try again.', 'error');
                    }
                };
                
                recognition.onend = function() {
                    isListening = false;
                    isInputMicrophoneActive = false;
                    inputMicrophoneBtn.classList.remove('listening');
                    voiceSearchBtn.classList.remove('listening');
                    document.getElementById('voiceInputStatus').classList.remove('active');
                    document.getElementById('voiceInputText').style.display = 'none';
                };
                
                voiceSearchBtn.addEventListener('click', toggleVoiceRecognition);
                inputMicrophoneBtn.addEventListener('click', toggleInputVoiceRecognition);
            } else {
                voiceSearchBtn.style.display = 'none';
                inputMicrophoneBtn.style.display = 'none';
                showToast('Voice search not supported in your browser', 'warning');
            }
            
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Sidebar toggle buttons
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            
            sidebarClose.addEventListener('click', function() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                this.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            // Sidebar tab switching
            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update active tab
                    sidebarTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    // If switching to history tab, refresh the list
                    if (tabId === 'chat-history') {
                        loadHistoryList();
                    }
                });
            });
            
            // New chat button
            newChatBtn.addEventListener('click', createNewChat);
            
            clearChatBtn.addEventListener('click', clearCurrentChat);
            downloadCurrentBtn.addEventListener('click', () => {
                if (conversationHistory.length === 0) {
                    showToast('No chat content to download', 'warning');
                    return;
                }
                openDownloadModal();
            });
            suggestionsBtn.addEventListener('click', showSuggestions);
            
            // Topic click handlers
            topicItems.forEach(item => {
                item.addEventListener('click', function() {
                    const topic = this.dataset.topic;
                    const questions = {
                        'contract': 'What are the essential elements of a valid contract under Indian law?',
                        'employment': 'What are the rights of employees regarding workplace harassment in India?',
                        'intellectual': 'How does copyright protection work for software in India?',
                        'realestate': 'What documents are required for property registration in India?',
                        'family': 'What are the grounds for divorce under Hindu Marriage Act?',
                        'criminal': 'What is the difference between bailable and non-bailable offenses?'
                    };
                    
                    userInput.value = questions[topic] || `Tell me about ${topic} law in India.`;
                    userInput.focus();
                    userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
                    
                    // Close sidebar on mobile/tablet
                    if (window.innerWidth < 1024) {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            });
            
            // Action click handlers
            actionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.dataset.action;
                    
                    if (action === 'document-drafts') {
                        userInput.value = 'Create a non-disclosure agreement draft for me';
                        userInput.focus();
                    } else if (action === 'legal-research') {
                        userInput.value = 'Can you help me research case laws related to breach of contract?';
                        userInput.focus();
                    } else if (action === 'case-analysis') {
                        userInput.value = 'Can you analyze the legal principles in landmark privacy law cases?';
                        userInput.focus();
                    }
                    
                    // Close sidebar on mobile/tablet
                    if (window.innerWidth < 1024) {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            });
            
            // Draft template click handlers
            draftTemplates.forEach(template => {
                template.addEventListener('click', function() {
                    const templateType = this.dataset.template;
                    let requestText = '';
                    
                    switch(templateType) {
                        case 'nda':
                            requestText = 'Create a comprehensive non-disclosure agreement for Indian business use';
                            break;
                        case 'employment':
                            requestText = 'Draft an employment contract template for Indian companies';
                            break;
                        case 'rental':
                            requestText = 'Create a rental/tenancy agreement for residential property in India';
                            break;
                        case 'loan':
                            requestText = 'Draft a loan agreement template for personal lending in India';
                            break;
                    }
                    
                    userInput.value = requestText;
                    userInput.focus();
                    userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
                    
                    // Auto-send after 1 second
                    setTimeout(() => {
                        sendMessage();
                    }, 1000);
                });
            });
            
            // Attachment button click
            attachmentBtn.addEventListener('click', openImageUploadModal);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                const isMobile = window.innerWidth < 1024;
                if (isMobile && sidebar.classList.contains('active') && 
                    !sidebar.contains(event.target) && 
                    !sidebarToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            
            // Focus input on load
            userInput.focus();
            
            // Adjust textarea height on page load
            setTimeout(() => {
                userInput.style.height = 'auto';
                userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
            }, 100);
            
            // Initialize scroll to bottom button
            const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
            if (scrollToBottomBtn) {
                scrollToBottomBtn.addEventListener('click', scrollToBottom);
            }
            
            // Monitor scroll position
            if (chatMessages) {
                chatMessages.addEventListener('scroll', checkScrollPosition);
                // Initial check
                setTimeout(checkScrollPosition, 500);
                
                // Also check when new messages are added
                const observer = new MutationObserver(checkScrollPosition);
                observer.observe(chatMessages, { childList: true, subtree: true });
            }
            
            // Add copy buttons to existing user messages
            setTimeout(addCopyEditButtonsToUserMessages, 1000);
            
            // Initialize send button state
            sendButton.disabled = userInput.value.trim() === '' && attachedImages.length === 0;
            
            // Adjust chat layout
            setTimeout(adjustChatLayout, 100);
        }
        
        // MODIFIED: Save current chat to history - now user-specific
        function saveCurrentChat() {
            if (!currentUser) {
                // If not logged in, use guest storage
                saveChatHistory();
                return;
            }
            
            if (!currentChatId || conversationHistory.length === 0) return;
            
            // Find chat in history
            const chatIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
            
            // Generate title from first user message
            let title = 'New Chat';
            let preview = 'No messages yet';
            
            if (conversationHistory.length > 0) {
                const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
                if (firstUserMessage) {
                    title = firstUserMessage.content.substring(0, 30);
                    if (firstUserMessage.content.length > 30) {
                        title += '...';
                    }
                }
                
                const lastMessage = conversationHistory[conversationHistory.length - 1];
                if (lastMessage) {
                    preview = lastMessage.content.substring(0, 50);
                    if (lastMessage.content.length > 50) {
                        preview += '...';
                    }
                }
            }
            
            if (chatIndex !== -1) {
                // Update existing chat
                chatHistory[chatIndex] = {
                    id: currentChatId,
                    title: title,
                    preview: preview,
                    date: new Date().toISOString(),
                    messages: [...conversationHistory],
                    userId: currentUser.id // Store user ID with chat
                };
            } else {
                // Add new chat
                chatHistory.unshift({
                    id: currentChatId,
                    title: title,
                    preview: preview,
                    date: new Date().toISOString(),
                    messages: [...conversationHistory],
                    userId: currentUser.id // Store user ID with chat
                });
            }
            
            // Save to user-specific storage
            saveUserChatHistory();
        }
        
        // MODIFIED: Load chat history - now user-specific
        function loadChatHistory() {
            if (!currentUser) {
                // If not logged in, use guest storage
                try {
                    const savedHistory = localStorage.getItem('legalSwamiChatHistory');
                    if (savedHistory) {
                        chatHistory = JSON.parse(savedHistory);
                    }
                    
                    const savedChatId = localStorage.getItem('legalSwamiCurrentChatId');
                    if (savedChatId) {
                        currentChatId = savedChatId;
                        // Load the current chat's messages
                        const currentChat = chatHistory.find(chat => chat.id === currentChatId);
                        if (currentChat) {
                            conversationHistory = [...currentChat.messages];
                        }
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    chatHistory = [];
                }
                return;
            }
            
            // Load user-specific chat history
            loadUserChatHistory();
        }
        
        // MODIFIED: Save chat history - now user-specific
        function saveChatHistory() {
            if (currentUser) {
                // If logged in, use user-specific storage
                saveUserChatHistory();
                return;
            }
            
            // Guest storage
            try {
                localStorage.setItem('legalSwamiChatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('legalSwamiCurrentChatId', currentChatId);
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }
        
        // MODIFIED: Delete chat from history - now user-specific
        function deleteChatFromHistory() {
            const chatId = document.getElementById('deleteModal').dataset.chatId;
            const chatIndex = chatHistory.findIndex(chat => chat.id === chatId);
            
            if (chatIndex !== -1) {
                // Check if we're deleting the current chat
                if (currentChatId === chatId) {
                    createNewChat();
                }
                
                // Remove from history
                chatHistory.splice(chatIndex, 1);
                
                // Update storage
                saveChatHistory();
                
                // Update UI
                loadHistoryList();
                
                // Close modal
                document.getElementById('deleteModal').classList.remove('active');
                
                // Show toast
                showToast('Chat deleted successfully', 'success');
            }
        }
        
        // Save chat history to localStorage
        function saveChatHistory() {
            try {
                localStorage.setItem('legalSwamiChatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('legalSwamiCurrentChatId', currentChatId);
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }
        
        // Load chat history from localStorage
        function loadChatHistory() {
            try {
                const savedHistory = localStorage.getItem('legalSwamiChatHistory');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                }
                
                const savedChatId = localStorage.getItem('legalSwamiCurrentChatId');
                if (savedChatId) {
                    currentChatId = savedChatId;
                    // Load the current chat's messages
                    const currentChat = chatHistory.find(chat => chat.id === currentChatId);
                    if (currentChat) {
                        conversationHistory = [...currentChat.messages];
                    }
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                chatHistory = [];
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Send message function - UPDATED WITH IMAGE ATTACHMENTS AND MODEL FALLBACK
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const message = userInput.value.trim();
            
            // Check if there's either text or attachments
            if (!message && attachedImages.length === 0) return;
            
            // Stop voice recognition if active
            if (isListening && recognition) {
                recognition.stop();
            }
            
            // Detect language if there's text
            let detectedLanguage = 'english';
            if (message) {
                detectedLanguage = detectLanguage(message);
                hideLanguageHint();
            }
            
            // Add user message to chat with attachments
            const messageId = addMessageToChat(message, true, false, false, attachedImages);
            userInput.value = '';
            userInput.style.height = '56px';
            sendButton.disabled = true;
            
            // Clear attachments after sending
            clearAttachments();
            
            try {
                // Store message in conversation history
                const userMessage = {
                    role: 'user',
                    content: message,
                    language: detectedLanguage,
                    attachments: [...attachedImages]
                };
                
                conversationHistory.push(userMessage);
                
                // If there are images, just acknowledge them
                if (attachedImages.length > 0 && !message) {
                    // Create AI message acknowledging the images
                    const aiMessage = {
                        role: 'assistant',
                        content: `I see you've uploaded ${attachedImages.length} image(s). How can I help you with these images?`,
                        language: 'english'
                    };
                    
                    conversationHistory.push(aiMessage);
                    
                    // Add AI message to chat
                    addMessageToChat(aiMessage.content, false, false, false);
                } else {
                    // Call AI API for text-based queries with model fallback
                    const response = await callGroqAPIWithFallback(message, detectedLanguage, attachedImages);
                    
                    // Store AI response in conversation history
                    const aiMessage = {
                        role: 'assistant',
                        content: response,
                        language: detectedLanguage,
                        isDocument: isDocumentRequest(message)
                    };
                    
                    conversationHistory.push(aiMessage);
                    
                    // Create AI message container for streaming
                    const aiMessageId = createStreamingMessage();
                    
                    // Start streaming the response
                    startStreamingResponse(aiMessageId, response, isDocumentRequest(message));
                }
                
                // Save current chat to history
                saveCurrentChat();
                
                // Update history list if we're on that tab
                if (document.querySelector('.sidebar-tab[data-tab="chat-history"]').classList.contains('active')) {
                    loadHistoryList();
                }
                
            } catch (error) {
                console.error('AI Service Error:', error);
                
                // Update with error message
                addMessageToChat("I apologize for the inconvenience. I'm currently experiencing technical difficulties. Please try again in a moment.", false);
                
                // Show subtle notification to user
                showToast('Service temporarily unavailable', 'warning');
            } finally {
                sendButton.disabled = userInput.value.trim() === '' && attachedImages.length === 0;
                document.getElementById('userInput').focus();
                
                // Adjust layout
                setTimeout(adjustChatLayout, 100);
                
                // Add copy/edit buttons to the new user message
                setTimeout(addCopyEditButtonsToUserMessages, 100);
            }
        }
        
        // Create streaming message container
        function createStreamingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove welcome message if it exists
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            messageDiv.id = messageId;
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = '<i class="fas fa-robot"></i>';
            
            // Message content
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text streaming-content';
            messageText.innerHTML = '<span class="streaming-cursor"></span>';
            
            messageContent.appendChild(messageText);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Set as current streaming message
            currentStreamingMessageId = messageId;
            currentStreamingContent = '';
            currentStreamingBuffer = '';
            streamingTextChunks = [];
            streamingTextIndex = 0;
            
            // Add streaming controls
            const streamControls = document.createElement('div');
            streamControls.className = 'stream-controls';
            streamControls.innerHTML = `
                <button class="stream-control-btn pause-btn" id="pause-${messageId}" onclick="toggleStreamPause('${messageId}')">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="stream-control-btn copy-btn" onclick="copyStreamedContent('${messageId}')">
                    <span class="square-copy-btn"></span> Copy
                </button>
            `;
            messageContent.appendChild(streamControls);
            
            // Don't auto-scroll - keep user at top
            // Just check scroll position
            setTimeout(checkScrollPosition, 100);
            
            return messageId;
        }
        
        // Start streaming response word by word
        function startStreamingResponse(messageId, response, isDocument = false) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            // Prepare text for streaming
            let textToStream = response;
            
            // Split text into chunks (words with punctuation)
            streamingTextChunks = splitTextIntoChunks(textToStream);
            streamingTextIndex = 0;
            
            // Start streaming
            streamNextChunk(messageId, isDocument);
        }
        
        // Split text into chunks for streaming
        function splitTextIntoChunks(text) {
            // Split by words and punctuation
            const chunks = [];
            const regex = /[\s.,;!?]+|\S+/g;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                chunks.push(match[0]);
            }
            
            return chunks;
        }
        
        // Stream next chunk of text
        function streamNextChunk(messageId, isDocument = false) {
            if (streamingTextIndex >= streamingTextChunks.length) {
                // Finished streaming
                finalizeStreamingMessage(messageId, isDocument);
                return;
            }
            
            const chunk = streamingTextChunks[streamingTextIndex];
            streamingTextIndex++;
            
            // Update the message with the new chunk
            updateStreamingMessage(messageId, chunk, isDocument);
            
            // Calculate delay for next chunk
            let delay = streamingWordDelay;
            
            // Add extra delay for punctuation
            if (chunk.match(/[.,;!?]/)) {
                delay += streamingPunctuationDelay;
            }
            
            // Add extra delay for sentence endings
            if (chunk.match(/[.!?]/)) {
                delay += 150;
            }
            
            // Schedule next chunk
            setTimeout(() => {
                if (!isStreamingPaused) {
                    streamNextChunk(messageId, isDocument);
                }
            }, delay);
        }
        
        // Toggle stream pause
        function toggleStreamPause(messageId) {
            isStreamingPaused = !isStreamingPaused;
            const pauseBtn = document.getElementById(`pause-${messageId}`);
            const messageDiv = document.getElementById(messageId);
            
            if (isStreamingPaused) {
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> Continue';
                pauseBtn.style.background = 'var(--success)';
                pauseBtn.style.borderColor = 'var(--success)';
                pauseBtn.style.color = 'white';
                
                // Add paused indicator to message
                const messageText = messageDiv.querySelector('.message-text');
                const existingIndicator = messageText.querySelector('.paused-indicator');
                if (!existingIndicator) {
                    const indicator = document.createElement('span');
                    indicator.className = 'paused-indicator';
                    indicator.textContent = 'Paused';
                    messageText.appendChild(indicator);
                }
                
                showToast('Response paused', 'info');
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                pauseBtn.style.background = '';
                pauseBtn.style.borderColor = '';
                pauseBtn.style.color = '';
                
                // Remove paused indicator
                const messageText = messageDiv.querySelector('.message-text');
                const existingIndicator = messageText.querySelector('.paused-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                // Resume streaming
                setTimeout(() => {
                    streamNextChunk(messageId, isDocumentRequest(currentStreamingContent));
                }, 100);
                
                showToast('Response continued', 'success');
            }
        }
        
        // Copy streamed content
        function copyStreamedContent(messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageText = messageDiv.querySelector('.message-text');
            const textToCopy = messageText.textContent.replace('Paused', '').trim();
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy', 'error');
            });
        }
        
        // Update streaming message with new content
        function updateStreamingMessage(messageId, newContent, isDocument = false) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageText = messageDiv.querySelector('.message-text');
            
            // Add to buffer
            currentStreamingBuffer += newContent;
            currentStreamingContent += newContent;
            
            // Update display
            if (isDocument) {
                // For documents, format as we stream
                messageText.innerHTML = formatDocumentResponse(currentStreamingContent) + '<span class="streaming-cursor"></span>';
            } else {
                // For regular text
                messageText.innerHTML = formatStreamingText(currentStreamingBuffer) + '<span class="streaming-cursor"></span>';
            }
            
            // Don't auto-scroll - keep user at top
            // Just check scroll position
            checkScrollPosition();
        }
        
        // Format text for streaming display
        function formatStreamingText(text) {
            // Basic formatting for streaming
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            return formatted;
        }
        
        // Finalize streaming message
        function finalizeStreamingMessage(messageId, isDocument = false) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageText = messageDiv.querySelector('.message-text');
            
            // Remove cursor and paused indicator
            const cursor = messageText.querySelector('.streaming-cursor');
            if (cursor) cursor.remove();
            
            const pausedIndicator = messageText.querySelector('.paused-indicator');
            if (pausedIndicator) pausedIndicator.remove();
            
            if (isDocument) {
                messageText.innerHTML = formatDocumentResponse(currentStreamingContent);
            } else {
                messageText.innerHTML = formatLegalResponse(currentStreamingContent);
            }
            
            // Add action buttons
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="action-btn copy" onclick="copyMessage(this)">
                    <span class="square-copy-btn"></span> Copy
                </button>
                <button class="action-btn like" onclick="likeMessage(this)">
                    <i class="far fa-thumbs-up"></i> Helpful
                </button>
                <button class="action-btn document" onclick="downloadThisMessage('${messageId}')">
                    <i class="fas fa-file-download"></i> Download
                </button>
            `;
            
            messageText.parentElement.appendChild(messageActions);
            
            // Remove streaming controls
            const streamControls = messageDiv.querySelector('.stream-controls');
            if (streamControls) {
                streamControls.remove();
            }
            
            // Add download button for documents
            if (isDocument) {
                addDocumentDownloadButton(messageId, currentStreamingContent);
            }
            
            // Reset streaming state
            currentStreamingMessageId = null;
            currentStreamingContent = '';
            currentStreamingBuffer = '';
            streamingTextChunks = [];
            streamingTextIndex = 0;
            isStreamingPaused = false;
            
            // Show attached images below the AI response if any
            if (attachedImages.length > 0) {
                showAttachedImagesBelowResponse(messageId);
            }
        }
        
        // Show attached images below AI response
        function showAttachedImagesBelowResponse(messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv || attachedImages.length === 0) return;
            
            const messageContent = messageDiv.querySelector('.message-content');
            const attachmentsContainer = document.createElement('div');
            attachmentsContainer.className = 'message-attachments';
            
            attachedImages.forEach((attachment, index) => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                
                attachmentItem.innerHTML = `
                    <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image">
                    <div class="attachment-name">${attachment.name}</div>
                `;
                
                attachmentsContainer.appendChild(attachmentItem);
            });
            
            // Insert after the message text
            const messageText = messageContent.querySelector('.message-text');
            messageContent.insertBefore(attachmentsContainer, messageText.nextSibling);
            
            // Clear attachments after showing
            clearAttachments();
        }
        
        // Call Groq API with model fallback
        async function callGroqAPIWithFallback(message, responseLanguage, attachments = []) {
            const isDocumentReq = isDocumentRequest(message);
            const systemPrompt = getSystemPrompt(responseLanguage, isDocumentReq);
            
            // Prepare messages array
            const messages = [
                { role: 'system', content: systemPrompt },
                ...conversationHistory.slice(-6).map(msg => ({
                    role: msg.role,
                    content: msg.content
                })),
                { role: 'user', content: message }
            ];

            // If there are attachments, add information about them
            if (attachments.length > 0) {
                const lastMessage = messages[messages.length - 1];
                lastMessage.content += `\n\n[User has attached ${attachments.length} image(s) with this message]`;
            }

            let lastError = null;
            
            // Try models in order
            for (const model of WORKING_MODELS) {
                try {
                    console.log(`Trying model: ${model}`);
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${GROQ_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 4000
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error with model ${model}: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log(`Success with model: ${model}`);
                    
                    // Update current model
                    currentModel = model;
                    
                    return data.choices[0].message.content;
                    
                } catch (error) {
                    console.error(`Failed with model ${model}:`, error);
                    lastError = error;
                    
                    // Try next model
                    continue;
                }
            }
            
            // If all models failed, throw the last error
            throw lastError || new Error('All models failed');
        }
        
        // Check if user is asking for document
        function isDocumentRequest(message) {
            const docKeywords = [
                'draft', 'template', 'format', 'document', 'agreement', 
                'contract', 'nda', 'non disclosure', 'employment', 
                'rental', 'loan', 'will', 'testament', 'legal document',
                'ready made', 'sample', 'example', 'form', '',
                '', '', '', '', '',
                '', '', '', '', 'create',
                'generate', 'make', 'prepare', 'write'
            ];
            
            const lowerMessage = message.toLowerCase();
            return docKeywords.some(keyword => lowerMessage.includes(keyword));
        }
        
        // Get system prompt based on response language
        function getSystemPrompt(language, isDocumentRequest = false) {
            if (isDocumentRequest) {
                const documentPrompts = {
                    'english': `You are LegalSwami, an expert AI legal assistant specializing in Indian law.
                    
IMPORTANT: When the user asks for a legal document draft, you MUST create a complete, ready-to-use legal document template. Include:
1. Proper document title and headings
2. All necessary legal clauses
3. Placeholders for personal information [like this]
4. Signature sections
5. Date and witness sections if applicable

Make sure the document is:
- Legally sound for Indian context
- Professionally formatted
- Ready for immediate download and use
- Includes all standard legal clauses

Format your response as a complete legal document.

ALWAYS include this disclaimer at the end:
"Disclaimer: This template is for educational purposes only. Consult a qualified attorney before use."`,

                    'hindi': ` LegalSwami ,     AI  

:        ,    ,           :
1.     
2.    
3.      [ ]
4.  
5.        

   :
-         
-     
-        
-      

           

      :
":                "`,

                    'marathi': ` LegalSwami ,    AI  .

:      ,    ,         .  :
1.     
2.    
3.    [ ]
4.  
5.      

    :
-     
-   
-      
-      

        .

     :
":      .     ."`
                };
                
                return documentPrompts[language] || documentPrompts['english'];
            }
            
            const generalPrompts = {
                'english': `You are LegalSwami, an expert AI legal assistant specializing in Indian law. 
                
CRITICAL RULE: Respond in the same language as the user's query. If user writes in Hindi, respond in Hindi. If in Marathi, respond in Marathi. If in English, respond in English.

Provide comprehensive, detailed legal information about Indian laws.
Cite relevant Indian laws, acts, and sections when applicable.
Mention important Indian legal precedents and case laws.
Explain legal concepts clearly with practical examples.
Include practical implications for Indian context.
Provide actionable advice when appropriate.

When answering:
- Structure your response with clear headings
- Use bullet points for lists
- Bold important terms and sections
- Include references to relevant laws
- Provide practical next steps

ALWAYS include this disclaimer at the end:
"Disclaimer: This information is for educational purposes only and not legal advice. Consult a qualified attorney for specific legal matters."`,

                'hindi': ` LegalSwami ,     AI  

 :               ,         ,         ,     

           
  ,      
         
          
       
       

  :
-         
-        
-       
-      
-     

      :
":                       "`,

                'marathi': ` LegalSwami ,    AI  .

 :     .      .     .     .

        .
  ,      .
        .
      .
     .
     .

 :
-      
-    
-      
-     
-     

     :
":          .       ."`
            };
            
            return generalPrompts[language] || generalPrompts['english'];
        }
        
        // Enhanced language detection with priority for English
        function detectLanguage(text) {
            // First, check if the text contains any non-English script
            const hasNonEnglishScript = /[\u0900-\u097F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0A00-\u0A7F\u0A80-\u0AFF\u0980-\u09FF]/.test(text);
            
            // If no non-English script, default to English
            if (!hasNonEnglishScript) {
                // Check for common Hindi/Marathi words in Roman script
                const hindiMarathiWords = [
                    /\bmujhe\b/i, /\btumhe\b/i, /\bhindi\b/i, /\bmarathi\b/i,
                    /\bkya\b/i, /\bkyu\b/i, /\bkaise\b/i, /\bkab\b/i,
                    /\bmala\b/i, /\bmahiti\b/i, /\bsahayata\b/i, /\bkich\b/i
                ];
                
                let hindiMarathiScore = 0;
                hindiMarathiWords.forEach(pattern => {
                    if (pattern.test(text)) hindiMarathiScore++;
                });
                
                // If enough Hindi/Marathi words, detect language
                if (hindiMarathiScore >= 2) {
                    // Check for specific Marathi words
                    if (/\bmala\b/i.test(text) || /\bmahiti\b/i.test(text) || /\bsahayata\b/i.test(text)) {
                        return 'marathi';
                    }
                    // Check for specific Hindi words
                    if (/\bmujhe\b/i.test(text) || /\bkya\b/i.test(text) || /\bkyu\b/i.test(text)) {
                        return 'hindi';
                    }
                }
                
                return 'english';
            }
            
            // If there's non-English script, detect specific language
            if (/[\u0900-\u097F]/.test(text)) {
                // Devanagari script (Hindi, Marathi, Sanskrit, etc.)
                let marathiScore = 0;
                let hindiScore = 0;
                
                // Check for Marathi specific words
                const marathiWords = ['', '', '', '', '', '', '', '', '', '', '', ''];
                marathiWords.forEach(word => {
                    if (text.includes(word)) marathiScore++;
                });
                
                // Check for Hindi specific words
                const hindiWords = ['', '', '', '', '', '', '', '', '', ''];
                hindiWords.forEach(word => {
                    if (text.includes(word)) hindiScore++;
                });
                
                if (marathiScore > hindiScore) {
                    return 'marathi';
                } else if (hindiScore > 0) {
                    return 'hindi';
                }
                
                // Default to Hindi if we can't determine
                return 'hindi';
            }
            
            // Check for other Indian languages
            if (/[\u0B80-\u0BFF]/.test(text)) return 'tamil';
            if (/[\u0C00-\u0C7F]/.test(text)) return 'telugu';
            if (/[\u0C80-\u0CFF]/.test(text)) return 'kannada';
            if (/[\u0A00-\u0A7F]/.test(text)) return 'punjabi';
            if (/[\u0A80-\u0AFF]/.test(text)) return 'gujarati';
            if (/[\u0980-\u09FF]/.test(text)) return 'bengali';
            
            // Default to English
            return 'english';
        }
        
        // Add message to chat - UPDATED VERSION WITH ATTACHMENTS
        function addMessageToChat(content, isUser, fromHistory = false, isDocument = false, attachments = []) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove welcome message if it exists and this is a new message
            if (!fromHistory && isUser) {
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            messageDiv.id = messageId;
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            // Message content
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            if (isUser) {
                // User message with attachments
                if (content) {
                    messageText.textContent = content;
                }
                
                // Add attachments if any - THEY WILL BE ADDED BELOW THE MESSAGE
                if (attachments && attachments.length > 0) {
                    // Store attachments in a data attribute for later use
                    messageDiv.dataset.attachments = JSON.stringify(attachments.map(img => ({
                        name: img.name,
                        data: img.data
                    })));
                }
                
                // Add copy and edit buttons for user messages (not from history)
                if (!fromHistory) {
                    const controlsContainer = document.createElement('div');
                    controlsContainer.className = 'user-message-controls';
                    
                    controlsContainer.innerHTML = `
                        <button class="user-message-btn copy-btn" onclick="copyUserMessage('${messageId}')" title="Copy question">
                            <span class="square-copy-btn"></span>
                        </button>
                        <button class="user-message-btn edit-btn" onclick="editUserMessage('${messageId}')" title="Edit question">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    `;
                    
                    messageContent.appendChild(controlsContainer);
                }
                
            } else {
                // AI message
                if (isDocument) {
                    messageText.innerHTML = formatDocumentResponse(content);
                } else {
                    messageText.innerHTML = formatLegalResponse(content);
                }
            }
            
            messageContent.appendChild(messageText);
            
            // Action buttons for AI messages (not from history)
            if (!isUser && !fromHistory) {
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                messageActions.innerHTML = `
                    <button class="action-btn copy" onclick="copyMessage(this)">
                        <span class="square-copy-btn"></span> Copy
                    </button>
                    <button class="action-btn like" onclick="likeMessage(this)">
                        <i class="far fa-thumbs-up"></i> Helpful
                    </button>
                    <button class="action-btn document" onclick="downloadThisMessage('${messageId}')">
                        <i class="fas fa-file-download"></i> Download
                    </button>
                `;
                messageContent.appendChild(messageActions);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // If this is a user message with attachments, show them below the message
            if (isUser && attachments && attachments.length > 0) {
                showAttachedImagesBelowUserMessage(messageId, attachments);
            }
            
            // Don't auto-scroll - keep user at top
            // Just check scroll position
            setTimeout(checkScrollPosition, 100);
            
            return messageId;
        }
        
        // Show attached images below user message
        function showAttachedImagesBelowUserMessage(messageId, attachments) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv || !attachments || attachments.length === 0) return;
            
            const messageContent = messageDiv.querySelector('.message-content');
            const attachmentsContainer = document.createElement('div');
            attachmentsContainer.className = 'message-attachments';
            
            attachments.forEach((attachment, index) => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                
                attachmentItem.innerHTML = `
                    <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image">
                    <div class="attachment-name">${attachment.name}</div>
                `;
                
                attachmentsContainer.appendChild(attachmentItem);
            });
            
            // Insert after the message text
            const messageText = messageContent.querySelector('.message-text');
            messageContent.insertBefore(attachmentsContainer, messageText.nextSibling);
        }
        
        // Copy user message
        function copyUserMessage(messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageText = messageDiv.querySelector('.message-text');
            const textToCopy = messageText.textContent;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Question copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy question', 'error');
            });
        }
        
        // Edit user message
        function editUserMessage(messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageText = messageDiv.querySelector('.message-text');
            const content = messageText.textContent;
            
            const userInput = document.getElementById('userInput');
            userInput.value = content;
            userInput.focus();
            
            // Adjust textarea height
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
            
            // Show toast
            showToast('Question loaded for editing', 'info');
        }
        
        // Format document response
        function formatDocumentResponse(text) {
            // Create document template container
            const documentContainer = document.createElement('div');
            documentContainer.className = 'document-template';
            
            // Split into lines and format
            const lines = text.split('\n');
            let htmlContent = '';
            
            lines.forEach(line => {
                if (line.trim() === '') return;
                
                // Check for title
                if (line.toUpperCase() === line && line.length > 10 && !line.includes(':')) {
                    htmlContent += `<div class="document-header">
                        <h2 class="document-title">${line}</h2>
                        <div class="document-subtitle">Legal Document Template</div>
                    </div>`;
                }
                // Check for section
                else if (line.match(/^\d+\.\s+.+/) || line.match(/^[A-Z\s]+:$/)) {
                    htmlContent += `<div class="document-section">
                        <h3 class="document-section-title">${line}</h3>`;
                }
                // Check for clause
                else if (line.match(/^[a-z]\)\s+.+/)) {
                    htmlContent += `<div class="document-clause">
                        <div class="clause-title">${line}</div>`;
                }
                // Regular content
                else {
                    if (line.includes('___________________') || line.includes('________________')) {
                        htmlContent += `<div class="clause-content" style="border-bottom: 1px solid var(--dark-border); padding-bottom: 5px; margin-bottom: 10px;">${line}</div>`;
                    } else {
                        htmlContent += `<div class="clause-content">${line}</div>`;
                    }
                }
            });
            
            // Add signature section if not present
            if (!text.includes('Signature') && !text.includes('Witness')) {
                htmlContent += `
                    <div class="signature-section">
                        <div class="signature-line">
                            <div class="signature-block">
                                <div class="signature-name"></div>
                                <div class="signature-label">Signature</div>
                            </div>
                            <div class="signature-block">
                                <div class="signature-name"></div>
                                <div class="signature-label">Date</div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Add disclaimer
            htmlContent += `<div class="legal-note">
                <strong>Disclaimer:</strong> This template is for educational purposes only. Consult a qualified attorney before use.
            </div>`;
            
            documentContainer.innerHTML = htmlContent;
            
            return documentContainer.outerHTML;
        }
        
        // Format legal response
        function formatLegalResponse(text) {
            // Basic formatting
            let formatted = text
                .replace(/## (.*?)\n/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/- (.*?)\n/g, '<li>$1</li>')
                .replace(/\n/g, '<br>');
            
            // Wrap lists
            formatted = formatted.replace(/(<li>.*?<\/li>)/gs, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Add disclaimer styling
            if (formatted.includes('Disclaimer') || formatted.includes('') || formatted.includes('')) {
                formatted = formatted.replace(/(Disclaimer:.*?|:.*?|:.*?)(?=<br><br>|$)/is, 
                    '<div class="legal-note">$1</div>');
            }
            
            return '<div class="legal-content">' + formatted + '</div>';
        }
        
        // Add document download button to message
        function addDocumentDownloadButton(messageId, content) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageContent = messageDiv.querySelector('.message-content');
            const existingBtn = messageContent.querySelector('.document-download-btn');
            
            if (existingBtn) return;
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'document-download-btn';
            downloadBtn.innerHTML = '<i class="fas fa-file-download"></i> Download Document';
            downloadBtn.title = 'Download this document template';
            
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openMessageDownloadModal(content);
            });
            
            messageContent.appendChild(downloadBtn);
        }
        
        // Copy message function
        window.copyMessage = function(button) {
            const messageText = button.closest('.message-content').querySelector('.message-text');
            let textToCopy = messageText.innerText || messageText.textContent;
            
            // Create temporary textarea for copying
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Document copied to clipboard!', 'success');
                } else {
                    showToast('Failed to copy text', 'error');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                showToast('Failed to copy: ' + err, 'error');
            }
            
            document.body.removeChild(textarea);
        }
        
        // Like message function
        window.likeMessage = function(button) {
            button.innerHTML = '<i class="fas fa-thumbs-up"></i> Thank you!';
            button.style.background = 'var(--success)';
            button.style.borderColor = 'var(--success)';
            button.style.color = 'white';
            button.disabled = true;
            showToast('Thank you for your feedback!', 'success');
        }
        
        // Download this specific message
        window.downloadThisMessage = function(messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageText = messageDiv.querySelector('.message-text');
            const content = messageText.innerText || messageText.textContent;
            
            openMessageDownloadModal(content);
        }
        
        // Clear current chat
        function clearCurrentChat() {
            if (conversationHistory.length === 0 && attachedImages.length === 0) {
                showToast('Chat is already empty', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to clear the current chat?')) {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                conversationHistory = [];
                clearAttachments();
                
                // Add welcome message back
                createNewChat();
                
                showToast('Current chat cleared', 'success');
            }
        }
        
        // Show suggestions
        function showSuggestions() {
            const suggestions = [
                "Create a non-disclosure agreement draft",
                "I need an employment contract template",
                "Generate a rental agreement for me",
                "Draft a loan agreement document",
                "What are the essential elements of a valid contract?"
            ];
            
            addMessageToChat(
                `<h3>Suggested Questions:</h3>
                <ul>
                    ${suggestions.map(q => `<li style="cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.3s;" 
                        onmouseover="this.style.background='var(--dark-surface-light)'" 
                        onmouseout="this.style.background='transparent'"
                        onclick="document.getElementById('userInput').value = '${q}'; document.getElementById('userInput').focus(); document.getElementById('userInput').style.height = Math.min(document.getElementById('userInput').scrollHeight, 200) + 'px'">
                        ${q}
                    </li>`).join('')}
                </ul>
                <p>Click any question to add it to the input field.</p>`,
                false
            );
        }
        
        // Check scroll position and show/hide down arrow
        function checkScrollPosition() {
            const chatMessages = document.getElementById('chatMessages');
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            const indicator = document.getElementById('scrollPositionIndicator');
            
            if (!chatMessages) return;
            
            const isAtBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50;
            
            // Show/hide scroll to bottom button
            if (!isAtBottom) {
                scrollBtn.classList.add('visible');
                
                // Show scroll indicator if scrolled up
                if (chatMessages.scrollTop < scrollPosition) {
                    indicator.classList.add('visible');
                    setTimeout(() => {
                        indicator.classList.remove('visible');
                    }, 2000);
                }
            } else {
                scrollBtn.classList.remove('visible');
                indicator.classList.remove('visible');
            }
            
            scrollPosition = chatMessages.scrollTop;
        }
        
        // Scroll to bottom function
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
                document.getElementById('scrollToBottomBtn').classList.remove('visible');
            }
        }
        
        // Add copy and edit buttons to user messages
        function addCopyEditButtonsToUserMessages() {
            const userMessages = document.querySelectorAll('.user-message:not(.from-history) .message-content');
            userMessages.forEach((messageContent, index) => {
                // Check if controls already exist
                if (!messageContent.querySelector('.user-message-controls')) {
                    const messageDiv = messageContent.closest('.message');
                    const messageId = messageDiv.id;
                    const messageText = messageContent.querySelector('.message-text');
                    
                    if (messageText && messageText.textContent.trim()) {
                        const controlsContainer = document.createElement('div');
                        controlsContainer.className = 'user-message-controls';
                        
                        controlsContainer.innerHTML = `
                            <button class="user-message-btn copy-btn" onclick="copyUserMessage('${messageId}')" title="Copy question">
                                <span class="square-copy-btn"></span>
                            </button>
                            <button class="user-message-btn edit-btn" onclick="editUserMessage('${messageId}')" title="Edit question">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        `;
                        
                        messageContent.appendChild(controlsContainer);
                    }
                }
            });
        }
        
        // Format date for filename
        function formatDateForFilename(date) {
            return date.toISOString()
                .replace(/[:\-]/g, '')
                .replace('T', '_')
                .split('.')[0];
        }
        
        // Initialize scroll position variable
        let scrollPosition = 0;
    </script>
</body>
</html>
